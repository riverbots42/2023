#
# The most-complex of the ansible playbooks, we set up all the interface names
# and configure the IP addresses here, along with setting up the wifi AP and
# configure the DHCP daemon to hand out IP addresses on our networks.
#
---
- name: Configure network interfaces with correct names and WAN MAC.
  hosts: all
  become: true
  tasks:
  - name: Copy over the network interface autoconfig script.
    ansible.builtin.copy:
      src: generate-udev-rules.py
      dest: /usr/local/bin/generate-udev-rules
      mode: 0755
  - name: Run the network interface autoconfig script.
    shell: /usr/local/bin/generate-udev-rules
    register: interface_map
  - name: Output lines.
    debug:
      var: interface_map.stdout_lines
  - name: Copy in the network address translation rule config script.
    ansible.builtin.template:
      src: nft-rules.j2
      dest: /usr/local/bin/nft-rules
      owner: root
      group: root
      mode: 0755
  - name: Copy in the network address config file.
    ansible.builtin.template:
      src: interfaces.j2
      dest: /etc/network/interfaces
  - name: Copy in the AP config file.
    ansible.builtin.template:
      src: hostapd.conf.j2
      dest: /etc/hostapd/hostapd.conf
  - name: Enable the hostapd daemon.
    ansible.builtin.systemd:
      name: hostapd.service
      enabled: true
      masked: false
      state: restarted
    ignore_errors: true
  - name: Copy in the DHCP config file.
    ansible.builtin.template:
      src: dnsmasq.conf.j2
      dest: /etc/dnsmasq.d/dnsmasq.conf
  - name: Enable the DHCP daemon.
    ansible.builtin.systemd:
      name: dnsmasq.service
      enabled: true
      masked: false
      state: restarted
    ignore_errors: true
  - name: Copy the systemd unit file to the target.
    ansible.builtin.copy:
      src: nft-rules.service
      dest: /lib/systemd/system/nft-rules.service
      mode: 0644
      owner: root
      group: root
  - name: Activate the network firewall service.
    ansible.builtin.systemd:
      name: nft-rules.service
      enabled: true
      masked: false
      daemon_reload: true
      state: restarted
